from unittest.mock import MagicMock

import numpy as np
import pytest

from dfastbe.bank_erosion.mesh_processor import intersect_line_mesh


class TestMeshProcessor:

    @pytest.fixture
    def mesh_data(self) -> MagicMock:
        """Fixture to provide a mock mesh data object."""
        mesh_data = MagicMock()
        # Define two adjacent square faces (quads) with 4 nodes each, sharing an edge
        mesh_data.x_face_coords = np.array(
            [
                [209253.125, 209252.734375, 209271.921875, 209273.3125],
                [209252.734375, 209253.046875, 209271.3125, 209271.921875],
                [209271.921875, 209271.3125, 209290.453125, 209292.125],
                [209271.3125, 209271.40625, 209289.546875, 209290.453125],
            ]
        )
        mesh_data.y_face_coords = np.array(
            [
                [389624.40625, 389663.96875, 389664.25, 389625.09375],
                [389663.96875, 389704.0, 389703.96875, 389664.25],
                [389664.25, 389703.96875, 389704.34375, 389665.0625],
                [389703.96875, 389744.0625, 389744.09375, 389704.34375],
            ]
        )
        mesh_data.face_node = np.array(
            [[2, 0, 5, 6], [0, 1, 3, 5], [5, 3, 8, 9], [3, 4, 7, 8]]
        )
        mesh_data.n_nodes = np.array([4] * 4)
        mesh_data.x_edge_coords = np.array(
            [
                [209253.125, 209273.3125],
                [209253.125, 209252.734375],
                [209252.734375, 209271.921875],
                [209273.3125, 209271.921875],
                [209252.734375, 209271.921875],
                [209252.734375, 209253.046875],
                [209253.046875, 209271.3125],
                [209271.921875, 209271.3125],
                [209271.921875, 209292.125],
                [209271.921875, 209271.3125],
                [209271.3125, 209290.453125],
                [209292.125, 209290.453125],
                [209271.3125, 209290.453125],
                [209271.3125, 209271.40625],
                [209271.40625, 209289.546875],
                [209290.453125, 209289.546875],
            ]
        )
        mesh_data.y_edge_coords = np.array(
            [
                [389624.40625, 389625.09375],
                [389624.40625, 389663.96875],
                [389663.96875, 389664.25],
                [389625.09375, 389664.25],
                [389663.96875, 389664.25],
                [389663.96875, 389704.0],
                [389704.0, 389703.96875],
                [389664.25, 389703.96875],
                [389664.25, 389665.0625],
                [389664.25, 389703.96875],
                [389703.96875, 389704.34375],
                [389665.0625, 389704.34375],
                [389703.96875, 389704.34375],
                [389703.96875, 389744.0625],
                [389744.0625, 389744.09375],
                [389704.34375, 389744.09375],
            ]
        )
        mesh_data.edge_node = np.array(
            [
                [2, 6],
                [2, 0],
                [0, 5],
                [6, 5],
                [0, 5],
                [0, 1],
                [1, 3],
                [5, 3],
                [5, 9],
                [5, 3],
                [3, 8],
                [9, 8],
                [3, 8],
                [3, 4],
                [4, 7],
                [8, 7],
            ]
        )
        mesh_data.edge_face_connectivity = np.array(
            [
                [0, -1],
                [0, -1],
                [0, 1],
                [0, -1],
                [-1, -1],
                [1, -1],
                [1, -1],
                [1, 2],
                [2, -1],
                [-1, -1],
                [2, 3],
                [2, -1],
                [-1, -1],
                [3, -1],
                [3, -1],
                [3, -1],
            ]
        )
        mesh_data.face_edge_connectivity = np.array(
            [[1, 2, 3, 0], [5, 6, 7, 2], [7, 10, 11, 8], [13, 14, 15, 10]]
        )
        mesh_data.boundary_edge_nrs = np.arange(16)
        return mesh_data

    @pytest.mark.parametrize(
        "line,expected_idx",
        [
            (
                np.array(
                    [
                        [209266.44709443, 389650.16238121],
                        [209266.44709443, 389651.16238121],
                    ]
                ),
                [0],
            ),
            (
                np.array(
                    [
                        [209266.44709443, 389650.16238121],
                        [209269.67183787, 389664.217019],
                    ]
                ),
                [0],
            ),
            (
                np.array(
                    [
                        [209266.44709443, 389650.16238121],
                        [209269.67183787, 389664.217019],
                        [209271.7614607, 389674.70572161],
                    ]
                ),
                [0, 1],
            ),
            (
                np.array(
                    [
                        [209266.44709443, 389650.16238121],
                        [209269.67183787, 389664.217019],
                        [209271.7614607, 389674.70572161],
                        [209278.48314731, 389704.10923615],
                    ]
                ),
                [0, 1, 2],
            ),
            (np.array([[100, 100], [120, 120]]), [-1]),
        ],
        ids=[
            "Within one square",
            "Match one square",
            "Match two squares",
            "Match three squares",
            "Outside mesh",
        ],
    )
    def test_intersect_line_mesh(self, mesh_data, line, expected_idx):
        crds, idx = intersect_line_mesh(line, mesh_data)
        assert np.allclose(crds, line)
        assert np.array_equal(idx, expected_idx)
